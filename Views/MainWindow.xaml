<Window x:Class="DerivSmartBotDesktop.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:controls="clr-namespace:DerivSmartBotDesktop.Views.Controls"
        Title="Deriv Smart Bot" Height="900" Width="1500"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource WindowBackgroundBrush}">
    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="56"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*"/>
            <RowDefinition Height="3*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0"
                Background="{DynamicResource TopBarBackgroundBrush}"
                BorderBrush="{DynamicResource DividerBrush}"
                BorderThickness="0,0,0,1"
                CornerRadius="10"
                Padding="12,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Deriv Smart Bot" FontSize="16" FontWeight="SemiBold"/>
                    <controls:StatusBadge Text="{Binding IsConnected, Converter={StaticResource BoolToText_Connected}}"
                                          IndicatorBrush="{Binding ConnectionBrush}"
                                          BadgeBrush="{DynamicResource BadgeNeutralBrush}"
                                          Margin="12,0,0,0"/>
                    <controls:StatusBadge Text="{Binding IsRunning, Converter={StaticResource BoolToText_Bot}}"
                                          IndicatorBrush="{DynamicResource PositiveBrush}"
                                          BadgeBrush="{DynamicResource BadgeNeutralBrush}"
                                          Margin="6,0,0,0"/>
                </StackPanel>

                <ScrollViewer Grid.Column="1"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled"
                              Margin="12,0">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Profile:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                        <ComboBox Width="140"
                                  ItemsSource="{Binding ProfileOptions}"
                                  SelectedItem="{Binding SelectedProfile}"
                                  Margin="0,0,12,0"/>

                        <CheckBox Content="Auto-start"
                                  IsChecked="{Binding AutoStartEnabled}"
                                  Margin="0,0,12,0"/>
                        <CheckBox Content="Auto symbol rotation"
                                  IsChecked="{Binding AutoRotateEnabled}"
                                  Margin="0,0,12,0"/>
                    </StackPanel>
                </ScrollViewer>

                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="Logs" Width="110" Command="{Binding OpenLogsWindowCommand}" Margin="0,0,8,0"/>
                    <Button Content="Start Bot" Width="120" Style="{StaticResource PrimaryButton}" Command="{Binding StartCommand}" Margin="0,0,8,0"/>
                    <Button Content="Stop Bot" Width="120" Style="{StaticResource GhostButton}" Command="{Binding StopCommand}" Margin="0,0,8,0"/>
                    <Button Content="Settings" Width="120" Command="{Binding OpenSettingsCommand}"/>
                </StackPanel>
            </Grid>
        </Border>

        <ItemsControl Grid.Row="1" ItemsSource="{Binding Kpis}" Margin="0,12,0,12">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <UniformGrid Columns="5"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <controls:KpiCard Title="{Binding Title}" Value="{Binding Value}" SubValue="{Binding SubValue}"
                                      AccentBrush="{Binding AccentBrush}" Margin="0,0,12,0"/>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Margin="0,0,12,0">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal">
                        <TextBlock Text="Strategy performance" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding ActiveStrategy}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="12,0,0,0"/>
                    </StackPanel>
                    <DataGrid ItemsSource="{Binding StrategyRows}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              EnableRowVirtualization="True"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              Margin="0,8,0,0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Strategy" Binding="{Binding Strategy}" Width="*"/>
                            <DataGridTextColumn Header="Win rate (%)" Binding="{Binding WinRate50, StringFormat={}{0:0.0}}" Width="90"/>
                            <DataGridTextColumn Header="Trades" Binding="{Binding Trades}" Width="70"/>
                            <DataGridTextColumn Header="Net P/L" Binding="{Binding AvgPL, StringFormat=$ {0:0.00}}" Width="90"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <StackPanel Grid.Column="1">
                <Border Style="{StaticResource CardBorderStyle}" Margin="0,0,0,12">
                    <StackPanel>
                        <TextBlock Text="Market conditions" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding ActiveSymbol}" Margin="0,8,0,0"/>
                        <TextBlock Text="{Binding MarketRegime}" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,4,0,0"/>
                        <TextBlock Text="Last skip reason" FontWeight="SemiBold" Margin="0,10,0,0"/>
                        <TextBlock Text="{Binding LastSkipReason}" Foreground="{DynamicResource TextSecondaryBrush}" TextWrapping="Wrap"/>
                        <TextBlock Text="Filters &amp; diagnostics" FontWeight="SemiBold" Margin="0,10,0,0"/>
                        <TextBlock Text="{Binding Diagnostics.ConnectionStatus}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <TextBlock Text="{Binding Diagnostics.MessageRate, StringFormat={}{0:0.0}/s}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardBorderStyle}">
                    <StackPanel>
                        <TextBlock Text="Rules &amp; auto-pause" FontWeight="SemiBold"/>
                        <TextBlock Text="{Binding RiskState, StringFormat=State: {0}}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <TextBlock Text="{Binding DailyLossLimit, StringFormat=Daily Loss Limit: {0:P0}}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <TextBlock Text="{Binding MaxConsecutiveLosses, StringFormat=Max Losses: {0}}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <TextBlock Text="{Binding CooldownSeconds, StringFormat=Cooldown: {0}s}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <TextBlock Text="{Binding StakeModel, StringFormat=Stake Model: {0}}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Grid>

        <Grid Grid.Row="3" Margin="0,12,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Margin="0,0,12,0">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="Recent trades" FontWeight="SemiBold"/>
                    <DataGrid ItemsSource="{Binding Trades.TradesView}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              EnableRowVirtualization="True"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              Margin="0,8,0,0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Time" Binding="{Binding Time, StringFormat={}{0:HH:mm:ss}}" Width="110"/>
                            <DataGridTextColumn Header="Symbol" Binding="{Binding Symbol}" Width="90"/>
                            <DataGridTextColumn Header="Strategy" Binding="{Binding Strategy}" Width="*"/>
                            <DataGridTextColumn Header="Dir" Binding="{Binding Direction}" Width="60"/>
                            <DataGridTextColumn Header="Stake" Binding="{Binding Stake, StringFormat=$ {0:0.00}}" Width="80"/>
                            <DataGridTextColumn Header="P/L" Binding="{Binding Profit, StringFormat=$ {0:0.00}}" Width="80"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>

            <Border Grid.Column="1" Style="{StaticResource CardBorderStyle}">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="Per-symbol stats" FontWeight="SemiBold"/>
                    <DataGrid ItemsSource="{Binding SymbolTiles}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              EnableRowVirtualization="True"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              Margin="0,8,0,0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Symbol" Binding="{Binding Symbol}" Width="80"/>
                            <DataGridTextColumn Header="Heat" Binding="{Binding Heat, StringFormat={}{0:0.0}}" Width="60"/>
                            <DataGridTextColumn Header="Regime" Binding="{Binding Regime}" Width="*"/>
                            <DataGridTextColumn Header="Win%" Binding="{Binding WinRate, StringFormat={}{0:0.0}}" Width="70"/>
                            <DataGridTextColumn Header="Trades" Binding="{Binding Trades}" Width="70"/>
                            <DataGridTextColumn Header="P/L" Binding="{Binding NetPL, StringFormat=$ {0:0.00}}" Width="80"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>
        </Grid>

        <controls:ToastHost Grid.RowSpan="4"/>
    </Grid>
</Window>
